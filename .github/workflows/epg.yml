name: Update EPG
on:
  schedule:
    - cron: '00 16 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      # æ£€å‡ºä»“åº“ä»£ç åˆ°å·¥ä½œç›®å½•

    - name: Set up Git user
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
      # é…ç½® Git æäº¤è€…ä¿¡æ¯

    - name: Create output directory (if not exists)
      run: mkdir -p output
      # åˆ›å»º output ç›®å½•ï¼ˆ-p ç¡®ä¿çˆ¶ç›®å½•ä¸å­˜åœ¨æ—¶ä¸æŠ¥é”™ï¼‰

    - name: Download EPG File to output directory
      run: wget http://epg.51zmt.top:8000/e.xml -O output/epg.xml
      # å°† EPG æ–‡ä»¶ä¸‹è½½åˆ° output ç›®å½•ä¸‹ï¼Œä¿å­˜ä¸º epg.xml

    - name: Calculate SHA-256 hash of new epg.xml
      id: calculate_hash
      run: |
        echo "hash=$(sha256sum output/epg.xml | awk '{print $1}')" >> "$GITHUB_ENV"
      # è®¡ç®— output ç›®å½•ä¸‹æ–°ä¸‹è½½æ–‡ä»¶çš„å“ˆå¸Œå€¼

    - name: Get previous SHA-256 hash from last commit
      id: get_previous_hash
      run: |
        if git show HEAD:output/epg.xml > /dev/null 2>&1; then
          # è‹¥å†å²æäº¤ä¸­å­˜åœ¨ output/epg.xmlï¼Œåˆ™è·å–å…¶å“ˆå¸Œ
          echo "previous_hash=$(git show HEAD:output/epg.xml | sha256sum | awk '{print $1}')" >> "$GITHUB_ENV"
        else
          # è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè®¾ä¸º none
          echo "previous_hash=none" >> "$GITHUB_ENV"
        fi
      # è·å–ä¸Šæ¬¡æäº¤ä¸­ output/epg.xml çš„å“ˆå¸Œå€¼ï¼ˆé€‚é…æ–°è·¯å¾„ï¼‰

    - name: Compare hashes and update if different
      run: |
        if [ "${{ env.hash }}" != "${{ env.previous_hash }}" ]; then
          git add output/epg.xml  # æ·»åŠ  output ç›®å½•ä¸‹çš„æ–‡ä»¶
          git commit -m "ğŸ“¡ $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin main
        else
          echo "No changes detected in output/epg.xml, skipping commit."
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # å¯¹æ¯”å“ˆå¸Œå¹¶æäº¤æ›´æ–°ï¼ˆè·¯å¾„è°ƒæ•´ä¸º output/epg.xmlï¼‰
        TZ: Asia/Shanghai  # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå°†æ—¶åŒºè®¾ç½®ä¸ºä¸Šæµ·
